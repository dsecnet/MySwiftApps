# Bakı Metro Stansiyaları - GPS Koordinatları
# Mənbə: Google Maps (2024)

BAKU_METRO_STATIONS = [
    # Qırmızı Xətt (M1) - Həzi Aslanov - Avtovağzal
    {
        "name": "Həzi Aslanov",
        "name_en": "Hazi Aslanov",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3816,
        "longitude": 49.8411,
        "opened": 1967
    },
    {
        "name": "Neftçilər",
        "name_en": "Neftchilar",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3885,
        "longitude": 49.8483,
        "opened": 1967
    },
    {
        "name": "Xalqlar Dostluğu",
        "name_en": "Xalqlar Dostluyu",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3973,
        "longitude": 49.8563,
        "opened": 1967
    },
    {
        "name": "Ulduz",
        "name_en": "Ulduz",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4050,
        "longitude": 49.8630,
        "opened": 1976
    },
    {
        "name": "Koroğlu",
        "name_en": "Koroglu",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4138,
        "longitude": 49.8693,
        "opened": 1989
    },
    {
        "name": "Qara Qarayev",
        "name_en": "Qara Qarayev",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4210,
        "longitude": 49.8748,
        "opened": 1989
    },
    {
        "name": "Nəriman Nərimanov",
        "name_en": "Nariman Narimanov",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4272,
        "longitude": 49.8796,
        "opened": 1985
    },
    {
        "name": "Bakmil",
        "name_en": "Bakmil",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4330,
        "longitude": 49.8837,
        "opened": 1976
    },
    {
        "name": "Üləvi Bulaq",
        "name_en": "Ulavi Bulaq",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4380,
        "longitude": 49.8870,
        "opened": 1976
    },
    {
        "name": "28 May",
        "name_en": "28 May",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4455,
        "longitude": 49.8920,
        "opened": 1970
    },
    {
        "name": "Gənclik",
        "name_en": "Ganjlik",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4520,
        "longitude": 49.8963,
        "opened": 1970
    },
    {
        "name": "Nərimanov",
        "name_en": "Narimanov",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4587,
        "longitude": 49.9007,
        "opened": 1976
    },
    {
        "name": "İnşaatçılar",
        "name_en": "Inshaatchilar",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4654,
        "longitude": 49.9052,
        "opened": 1976
    },
    {
        "name": "20 Yanvar",
        "name_en": "20 Yanvar",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.4720,
        "longitude": 49.9097,
        "opened": 1976
    },
    {
        "name": "Səhil",
        "name_en": "Sahil",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3690,
        "longitude": 49.8360,
        "opened": 2002
    },
    {
        "name": "İçərişəhər",
        "name_en": "Icheri Sheher",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3660,
        "longitude": 49.8320,
        "opened": 1967
    },
    {
        "name": "28 May (transfer)",
        "name_en": "28 May",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3742,
        "longitude": 49.8405,
        "opened": 1967
    },
    {
        "name": "Avtovağzal",
        "name_en": "Avtovagzal",
        "line": "M1",
        "line_name": "Qırmızı Xətt",
        "latitude": 40.3815,
        "longitude": 49.8462,
        "opened": 1972
    },

    # Yaşıl Xətt (M2) - Dərnəgül - Xocasən
    {
        "name": "Dərnəgül",
        "name_en": "Darnagul",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4025,
        "longitude": 50.0182,
        "opened": 2016
    },
    {
        "name": "Əhmədli",
        "name_en": "Ahmadli",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4128,
        "longitude": 50.0055,
        "opened": 2016
    },
    {
        "name": "Həzi Aslanov (transfer)",
        "name_en": "Hazi Aslanov",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4258,
        "longitude": 49.9868,
        "opened": 2012
    },
    {
        "name": "Azadlıq Prospekti",
        "name_en": "Azadliq Prospekti",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4385,
        "longitude": 49.9685,
        "opened": 2012
    },
    {
        "name": "8 Noyabr",
        "name_en": "8 Noyabr",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4510,
        "longitude": 49.9502,
        "opened": 2014
    },
    {
        "name": "Neftçilər (transfer)",
        "name_en": "Neftchilar",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4628,
        "longitude": 49.9328,
        "opened": 2014
    },
    {
        "name": "Xalqlar Dostluğu (transfer)",
        "name_en": "Xalqlar Dostluyu",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4742,
        "longitude": 49.9158,
        "opened": 2014
    },
    {
        "name": "Xocasən",
        "name_en": "Khojasan",
        "line": "M2",
        "line_name": "Yaşıl Xətt",
        "latitude": 40.4852,
        "longitude": 49.8998,
        "opened": 2018
    },

    # Bənövşəyi Xətt (M3) - Planlaşdırılır
    # Gələcək genişlənmə üçün yer saxlanılıb
]

# Bakı rayon mərkəzləri
BAKU_DISTRICTS = [
    {"name": "Nəsimi", "latitude": 40.4093, "longitude": 49.8671},
    {"name": "Nərimanov", "latitude": 40.4587, "longitude": 49.9007},
    {"name": "Yasamal", "latitude": 40.3960, "longitude": 49.8391},
    {"name": "Binəqədi", "latitude": 40.4531, "longitude": 49.8167},
    {"name": "Nizami", "latitude": 40.3851, "longitude": 49.8482},
    {"name": "Səbail", "latitude": 40.3662, "longitude": 49.8320},
    {"name": "Xətai", "latitude": 40.3752, "longitude": 49.8042},
    {"name": "Qaradağ", "latitude": 40.3947, "longitude": 50.0128},
    {"name": "Suraxanı", "latitude": 40.4363, "longitude": 50.0128},
    {"name": "Sabunçu", "latitude": 40.4575, "longitude": 49.9667},
    {"name": "Xəzər", "latitude": 40.4850, "longitude": 50.0783},
    {"name": "Pirallahı", "latitude": 40.4233, "longitude": 50.3917},
]

# Məşhur məkanlar
BAKU_LANDMARKS = [
    {"name": "Flame Towers", "type": "landmark", "latitude": 40.3594, "longitude": 49.8372},
    {"name": "Heydar Aliyev Center", "type": "cultural", "latitude": 40.3955, "longitude": 49.8677},
    {"name": "Fountains Square", "type": "landmark", "latitude": 40.3715, "longitude": 49.8384},
    {"name": "Port Baku Mall", "type": "mall", "latitude": 40.3715, "longitude": 49.8455},
    {"name": "Park Bulvar", "type": "mall", "latitude": 40.3635, "longitude": 49.8342},
    {"name": "Ganjlik Mall", "type": "mall", "latitude": 40.4520, "longitude": 49.8963},
    {"name": "28 Mall", "type": "mall", "latitude": 40.4442, "longitude": 49.8908},
    {"name": "Deniz Mall", "type": "mall", "latitude": 40.3705, "longitude": 49.8370},
    {"name": "Baku Olympic Stadium", "type": "sport", "latitude": 40.4295, "longitude": 49.9186},
    {"name": "Baku Crystal Hall", "type": "cultural", "latitude": 40.3707, "longitude": 49.8482},
]


def get_nearest_metro(latitude: float, longitude: float, max_distance_km: float = 5.0) -> dict:
    """
    Verilmiş koordinatlara ən yaxın metro stansiyasını tapır.

    Args:
        latitude: GPS enlik
        longitude: GPS uzunluq
        max_distance_km: Maksimum axtarış radiusu (km)

    Returns:
        {
            "station": "28 May",
            "line": "M1",
            "distance_m": 350,
            "distance_km": 0.35,
            "coordinates": {"lat": 40.4455, "lng": 49.8920}
        }
    """
    from math import radians, cos, sin, asin, sqrt

    def haversine(lon1, lat1, lon2, lat2):
        """
        Haversine formula - 2 GPS nöqtəsi arasında məsafə (km)
        """
        lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
        dlon = lon2 - lon1
        dlat = lat2 - lat1
        a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
        c = 2 * asin(sqrt(a))
        km = 6371 * c  # Yerin radiusu
        return km

    nearest = None
    min_distance = float('inf')

    for station in BAKU_METRO_STATIONS:
        distance_km = haversine(
            longitude, latitude,
            station['longitude'], station['latitude']
        )

        if distance_km < min_distance and distance_km <= max_distance_km:
            min_distance = distance_km
            nearest = {
                "station": station["name"],
                "station_en": station["name_en"],
                "line": station["line"],
                "line_name": station["line_name"],
                "distance_m": int(distance_km * 1000),
                "distance_km": round(distance_km, 2),
                "coordinates": {
                    "lat": station["latitude"],
                    "lng": station["longitude"]
                }
            }

    return nearest


def get_nearby_landmarks(latitude: float, longitude: float, radius_km: float = 2.0) -> list:
    """
    Yaxınlıqdakı məşhur məkanları tapır.

    Args:
        latitude: GPS enlik
        longitude: GPS uzunluq
        radius_km: Axtarış radiusu (km)

    Returns:
        [
            {"name": "28 Mall", "type": "mall", "distance_m": 450},
            {"name": "Ganjlik Mall", "type": "mall", "distance_m": 800}
        ]
    """
    from math import radians, cos, sin, asin, sqrt

    def haversine(lon1, lat1, lon2, lat2):
        lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
        dlon = lon2 - lon1
        dlat = lat2 - lat1
        a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
        c = 2 * asin(sqrt(a))
        return 6371 * c

    nearby = []

    for landmark in BAKU_LANDMARKS:
        distance_km = haversine(
            longitude, latitude,
            landmark['longitude'], landmark['latitude']
        )

        if distance_km <= radius_km:
            nearby.append({
                "name": landmark["name"],
                "type": landmark["type"],
                "distance_m": int(distance_km * 1000),
                "distance_km": round(distance_km, 2),
                "coordinates": {
                    "lat": landmark["latitude"],
                    "lng": landmark["longitude"]
                }
            })

    # Məsafəyə görə sırala
    nearby.sort(key=lambda x: x['distance_m'])

    return nearby


def get_district_for_coordinates(latitude: float, longitude: float) -> str:
    """
    Koordinatlara görə rayon təyin edir (sadə yaxınlıq əsasında).
    Real tətbiqdə daha dəqiq boundary check lazımdır.
    """
    from math import radians, cos, sin, asin, sqrt

    def haversine(lon1, lat1, lon2, lat2):
        lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
        dlon = lon2 - lon1
        dlat = lat2 - lat1
        a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
        c = 2 * asin(sqrt(a))
        return 6371 * c

    nearest_district = None
    min_distance = float('inf')

    for district in BAKU_DISTRICTS:
        distance = haversine(
            longitude, latitude,
            district['longitude'], district['latitude']
        )

        if distance < min_distance:
            min_distance = distance
            nearest_district = district["name"]

    return nearest_district or "Bakı"
